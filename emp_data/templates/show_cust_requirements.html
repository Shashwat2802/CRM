{% extends 'basic.html' %}
{% block extra %}
<script>
    $(document).ready(function () {
        $('#example').DataTable({
            dom: 'Bfrtip',
            buttons: [
                'copyHtml5',
                'excelHtml5',
                'csvHtml5'
            ],
        });
    });
</script>

{% endblock %}
{% block body %}
<center>
    <div>
        <h2 class="bg-info text-white">Customer Requirements</h2>
    </div>
</center>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.js"></script>
<div class="form-inline">
    <div class="d-inline-block">
        <span>
            <button class="btn-sm" onclick="location.href='/summary'">Summary</button>
        </span>
        <span>
            Sales
            <select name="saleslist" id="sales">
                <option value="{{sales_select}}" selected hidden disabled>{{sales_select}}</option>
                {% for val in sales_incharge %}
                <option value="{{val.eFname}}">{{val.eFname}}</option>
                {% endfor %}
                <option value="All">All</option>
            </select>
        </span>
        <span style="margin-left: 30;">
            BUH
            <select name="buhead" id="buhead">
                <option value="{{bu_select}}" selected disabled hidden>{{bu_select}}</option>
                {% for val in bu_head %}
                <option value="{{val.eFname}}">{{val.eFname}}</option>
                {% endfor %}
                <option value="All">All</option>
            </select>
        </span>

        <span style="margin-left: 30;">
            Status
            <select name="statuslist" id="status">
                <option value="{{status_select}}" selected disabled hidden>{{status_select}}</option>
                <option value="Active">Active</option>
                <option value="Inactive">Closed</option>
                <option value="All">Both</option>
            </select>
        </span>
        <span style="margin-left: 30;">
            <button class="go-btn" type="submit" onClick="window.location.href = getLink()">Search</button>

        </span>
        <span style="margin-left: 10;">
            <button class="go-btn" type="submit" onclick="location.href='/listSalesReqs'">Refresh</button>
        </span>

    </div>
</div>
<script>
    function getLink() {
        var buhead = document.querySelector("#buhead").value;
        var salesincharge = document.querySelector("#sales").value;
        var status = document.querySelector("#status").value;
        var url = '/filter/' + encodeURIComponent(buhead) + '/' + encodeURIComponent(salesincharge) + '/' + encodeURIComponent(status);
        return url;
    }
</script>

</div>
<table class="table relative-top" id="example">
    <thead class="badge-info text-white">
        <tr>
        <tr>
            <th>Req. ID</th>
            <th>Customers</th>
            <th>Cust. Req. ID</th>
            <th>Req. Skills</th>
            <th>Job Desc.</th>
            <th>Exp.</th>
            <th>Total Reqs</th>
            <th>Yet To Fill</th>
            <th>Status</th>
            <th>Sales Incharge</th>
            <th>BU Head</th>
            <th>Remarks</th>
            <th>Candidate List</th>
            <th>Actions</th>
        </tr>
        </tr>
    </thead>

    <tbody>
        {% for val in customer_requirements %}
        <tr>
            <div>
                <!--<td>{{customer_requirement.Requirement_Id}}</td>-->

                <td>{{forloop.counter}}</td>

                <td>{{val.customers}}</td>
                <td>{{val.Customer_Requirement_id}}</td>
                <td>{{val.Required_skills}}</td>
                <td>
                    <button type="button" class="btn-sm" data-toggle="modal"
                        data-target="#jobDescriptionModal{{val.Customer_Requirement_id}}">
                        {{ val.Job_Description|truncatewords:5 }}

                    </button>
                    <!-- Modal -->
                    <div class="modal fade" id="jobDescriptionModal{{val.Customer_Requirement_id}}" tabindex="-1"
                        role="dialog" aria-labelledby="jobDescriptionModalLabel{{val.Customer_Requirement_id}}"
                        aria-hidden="true">
                        <div class="modal-dialog modal-dialog-scrollable" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title"
                                        id="jobDescriptionModalLabel{{val.Customer_Requirement_id}}">Job Description
                                    </h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <p>{{val.Job_Description}}</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </td>

                <td>{{val.Required_Experience}}</td>
                <td>{{val.Open_positions}}</td>
                <td>{{val.remain_positions}}</td>
                <td>{{val.Position_Status}}</td>
                <td>{{val.Sales_Incharge}}</td>
                <td>{{val.Bu_head}}</td>

                <td>
                    <button type="button" class="btn-sm btn-info" data-toggle="modal"
                        data-target="#BURemarksModal{{val.Customer_Requirement_id}}">
                        <i class="fa-regular fa-eye"></i>
                    </button>
                    <!-- Modal -->
                    <div class="modal fade" id="BURemarksModal{{val.Customer_Requirement_id}}" tabindex="-1"
                        role="dialog" aria-labelledby="BURemarksModalLabel{{val.Customer_Requirement_id}}"
                        aria-hidden="true">
                        <div class="modal-dialog modal-dialog-scrollable" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="BURemarksModalLabel{{val.Customer_Requirement_id}}">
                                        Remarks of: {{val.customers}}</h5>

                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    {% for remark in remarks reversed%}
                                    {% if remark.cust_id == val.Customer_Requirement_id %}
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title">{{remark.refer_emp}}</h5>
                                            <h6 class="card-subtitle mb-2 text-body-secondary">Created on
                                                {{remark.remark_date}}</h6>
                                        </div>
                                        <div class="card-body">
                                            <p>{{remark.remarks}}</p>
                                        </div>

                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!--For the edit button-->
                    {% if current_user == val.Sales_Incharge or current_user == val.Bu_head %}
                    <button type="button" class="btn-sm btn-success" data-toggle="modal"
                        data-target="#BURemarksEdit{{val.Customer_Requirement_id}}">
                        <i class="fa-regular fa-pen-to-square"></i>
                    </button>

                    {% else %}
                    <span class="d-inline-block" tabindex="0" data-bs-toggle="popover{{val.Customer_Requirement_id}}"
                        data-bs-trigger="hover focus"
                        data-bs-content="Authorized for {{val.Sales_Incharge}} and {{val.Bu_head}}"
                        data-bs-placement="bottom">
                        <button class="btn-sm btn-danger" type="button" disabled>
                            <i class="fa-regular fa-pen-to-square"></i>
                        </button>
                    </span>

                    <script>
                        $(function () {
                            $('[data-bs-toggle="popover{{val.Customer_Requirement_id}}"]').popover({ trigger: "hover focus" })
                        })
                    </script>
                    {% endif %}
                    <!-- Modal form -->
                    <div class="modal" id="BURemarksEdit{{val.Customer_Requirement_id}}" data-bs-backdrop="static"
                        data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-scrollable">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5" id="staticBackdropLabel">Update remarks</h1>
                                    <button type="button" class="close" data-dismiss="modal"
                                        aria-label="Close">&times;</button>
                                </div>

                                <div class="modal-body">
                                    <!-- <nav class="navbar bg-body-tertiary"> -->
                                    <div class="container-fluid">
                                        <form action="/remarks/{{val.Customer_Requirement_id}}" method="POST">
                                            {% csrf_token %}
                                            <div class="form-group">
                                                <label for="Job_Description">Edit remarks:</label>
                                                <textarea name="remark_text" id="remark_text" cols="50"
                                                    rows="10"></textarea>
                                            </div>
                                            <button type="submit" class="btn btn-primary">Add Comment</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                </td>

                <!-- Button trigger modal -->
                <td>
                    <button type="button" class="btn-warning btn-sm"
                        onclick="location.href='/show_candidate/{{val.customers}}/{{val.Customer_Requirement_id}}'">
                        <i class="fa-sharp fa-regular fa-plus"></i>
                    </button>
                    <button type="button" class="btn-info btn-sm"
                        onclick="location.href='/showEmpToCustomer/{{val.customers}}/{{val.Customer_Requirement_id}}'">

                        <i class="fa-regular fa-eye"></i>
                    </button>
                </td>
                <td>
                    <button class="btn-success btn-sm" data-toggle="modal"
                        data-target="#modalForm{{val.Customer_Requirement_id}}"><i
                            class="fa-solid fa-pen-to-square"></i></button>
                    <!-- Modal form -->
                    <div class="modal" id="modalForm{{val.Customer_Requirement_id}}" data-bs-backdrop="static"
                        data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-scrollable">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5" id="staticBackdropLabel">Enter the new details</h1>
                                    <button type="button" class="close" data-dismiss="modal"
                                        aria-label="Close">&times;</button>
                                </div>

                                <div class="modal-body">
                                    <div class="container-fluid">
                                        <h6>Customer : {{val.customers}}</h6>
                                        <h6>Customer Requirement id : {{val.Customer_Requirement_id}}</h6>
                                        <form action="/updateSaleReqs/{{val.Customer_Requirement_id}}" method="POST">
                                            {% csrf_token %}
                                            <div class="form-group">
                                                <label for="Required_skills">Updated Required Skills:</label>
                                                <input type="text" class="form-control" id="Required_skills"
                                                    name="Required_skills" value="{{val.Required_skills}}">
                                            </div>
                                            <div class="form-group">
                                                <label for="Job_Description">Updated Job Description:</label>
                                                <textarea name="Job_Description" id="Job_Description" cols="50"
                                                    rows="20">{{val.Job_Description}}</textarea>
                                            </div>
                                            <div class="form-group">
                                                <label for="Required_Experience">Updated Required
                                                    Experience:</label>
                                                <input type="number" class="form-control" id="Required_Experience"
                                                    name="Required_Experience" placeholder="enter required experience"
                                                    value="{{val.Required_Experience}}" min="0" max="100" step="0.1">
                                            </div>
                                            <div class="form-group">
                                                <label for="Open_positions">Updated Open positions:</label>
                                                <input type="number" class="form-control" id="Open_positions"
                                                    name="Open_positions" placeholder="Enter opened positions"
                                                    value="{{val.Open_positions}}">
                                            </div>

                                            <div class="form-group">
                                                <label for="Position_Status">Updated Position Status:</label>
                                                <input type="text" class="form-control" id="Position_Status"
                                                    name="Position_Status"
                                                    placeholder="Enter position status active or not"
                                                    value="{{val.Position_Status}}">
                                            </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="Sales_Incharge">Sales Incharge</label>
                                        <select name="Sales_Incharge" id="Sales_Incharge">
                                            {% for val in sales_incharge %}
                                            <option value="{{val}}">{{val}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="Bu_Head">Bu Head:</label>
                                        <select name="Bu_Head" id="Bu_Head">
                                            {% for val in bu_head %}
                                            <option value="{{val}}">{{val}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Update</button>

                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
        </tr>
        {% endfor %}
    </tbody>

</table>
</div>
{% endblock %}
<!-- </nav> -->

